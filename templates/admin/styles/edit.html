{% extends "admin/layout_admin.html" %}

{% block head %}
  <!-- Include JSONEditor library -->
  <link href="/static/css/jsoneditor.min.css" rel="stylesheet" />
  <script src="/static/js/jsoneditor.min.js"></script>
{% endblock %}


{% block admin_content %}

<div class="has-text-left">
  <a href="/admin/styles" class="button is-light">
    <span class="icon is-small">
      <i class="fas fa-arrow-left"></i>
    </span>
    <span>Back</span>
  </a>
</div>

<div class="columns is-centered">
  <div class="column is-three-quarters">
    <h1 class="mb-3 title is-5 has-text-grey-darker">Edit Style {{ style.name }}</h1>

    <form action="/admin/styles/update" method="post">

      <div class="field">
        <label class="label">ID</label>
        <div class="control">
          <input class="input" name="id" type="text" placeholder="ID" value="{{ style.id }}" readonly>
        </div>
      </div>

      <!--Category-->
      <div class="field">
        <label class="label">Category</label>
        <div class="control">
          <div class="select is-fullwidth">
            <select name="category" id="category">
              {% for category in categories %}
              <option value="{{ category.id }}" {% if category.id == style.category.id %}selected{% endif %}>{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <div class="field">
        <label class="label">Name</label>
        <div class="control">
          <input class="input" name="name" type="text" placeholder="Name" value="{{ style.name }}">
        </div>
      </div>

      <div class="field">
        <label class="label">Description</label>
        <div class="control">
          <input class="input" name="description" type="text" placeholder="Description" value="{{ style.description }}">
        </div>
      </div>

      <!-- JSON Editor for Style -->
      <div class="field">
        <label class="label">Style</label>
        <div class="control">
          <!-- JSON Editor container -->
          <div id="jsoneditor" style="height: 800px; border: 1px solid #ddd;"></div>
          <!-- Hidden input to store JSON -->
          <input type="hidden" id="jsonInput" name="style">
        </div>
      </div>

      <div id="jsonError" class="has-text-danger" style="display: none;">
        Invalid JSON format. Please check the syntax.
      </div>

      <div class="field">
        <div class="control has-text-centered">
          <button class="button is-fullwidth is-link">Update Style</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById('jsoneditor');
    const hiddenInput = document.getElementById('jsonInput');
    const errorMessage = document.getElementById('jsonError');

    let currentStyle = `{{ style.style|safe }}`;

    const editor = new JSONEditor(container, {
      modes: ['code', 'tree', 'text', 'preview'],
      mode: 'code',
    });

    try {
      currentStyle = JSON.parse(currentStyle);
      editor.set(currentStyle);
    } catch (e) {
      errorMessage.style.display = 'block';
    }

    const acePowered = document.querySelector('.jsoneditor-poweredBy');
    if (acePowered) {
      acePowered.style.display = 'none';
    }

    document.querySelector('form').addEventListener('submit', (event) => {
      try {
        const json = editor.get();
        JSON.stringify(json);
        hiddenInput.value = JSON.stringify(json);
      } catch (e) {
        event.preventDefault();
        errorMessage.style.display = 'block';
      }
    });
  });
</script>
{% endblock %}
